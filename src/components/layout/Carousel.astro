---
/**
 * Carousel Component
 *
 * Image/content carousel powered by Swiper.js.
 * Supports autoplay, multiple effects, navigation, and keyboard controls.
 *
 * @component
 * @example
 * ```astro
 * <Carousel
 *   items={[
 *     { src: '/img1.jpg', alt: 'Image 1' },
 *     { src: '/img2.jpg', alt: 'Image 2' }
 *   ]}
 *   autoplay
 *   showNavigation
 * />
 * ```
 */

export interface CarouselItem {
    src: string;
    alt: string;
    caption?: string;
}

export interface Props {
    /** Carousel items (if not using slot content) */
    items?: CarouselItem[];
    /** Transition effect */
    effect?: "slide" | "fade" | "cube";
    /** Enable autoplay */
    autoplay?: boolean;
    /** Autoplay delay in milliseconds */
    autoplayDelay?: number;
    /** Enable loop */
    loop?: boolean;
    /** Show navigation arrows */
    showNavigation?: boolean;
    /** Show pagination dots */
    showPagination?: boolean;
    /** Enable Ken Burns zoom effect on images */
    kenBurns?: boolean;
    /** Carousel height */
    height?: string;
    /** Additional CSS classes */
    class?: string;
}

const {
    items,
    effect = "fade",
    autoplay = false,
    autoplayDelay = 4000,
    loop = true,
    showNavigation = false,
    showPagination = false,
    kenBurns = false,
    height = "70vh",
    class: className = "",
} = Astro.props;

// Generate unique ID for this carousel instance
const carouselId = `carousel-${Math.random().toString(36).substring(2, 11)}`;
---

<div
    class:list={["carousel-container", className]}
    style={`height: ${height};`}
>
    <div class={`swiper ${carouselId}`}>
        <div class="swiper-wrapper">
            {
                items ? (
                    items.map((item, index) => (
                        <div class="swiper-slide">
                            <img
                                src={item.src}
                                alt={item.alt}
                                class:list={[
                                    "carousel-image",
                                    kenBurns && "ken-burns",
                                ]}
                                loading={index === 0 ? "eager" : "lazy"}
                                fetchpriority={index === 0 ? "high" : "auto"}
                            />
                            {item.caption && (
                                <div class="carousel-caption">
                                    <p>{item.caption}</p>
                                </div>
                            )}
                        </div>
                    ))
                ) : (
                    <slot />
                )
            }
        </div>

        <!-- Navigation arrows -->
        {
            showNavigation && (
                <>
                    <div class="swiper-button-prev" />
                    <div class="swiper-button-next" />
                </>
            )
        }

        <!-- Pagination -->
        {showPagination && <div class="swiper-pagination" />}
    </div>
</div>

<style>
    .carousel-container {
        position: relative;
        width: 100%;
        overflow: hidden;
    }

    .swiper {
        width: 100%;
        height: 100%;
    }

    .swiper-slide {
        display: flex;
        justify-content: center;
        align-items: center;
        position: relative;
        overflow: hidden;
    }

    .carousel-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 10s ease-out;
    }

    /* Ken Burns effect: active slide zooms in */
    .swiper-slide-active .ken-burns {
        transform: scale(1.1);
    }

    .carousel-caption {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        padding: 2rem;
        background: linear-gradient(to top, rgba(0, 0, 0, 0.8), transparent);
        color: white;
        text-align: center;
    }

    .carousel-caption p {
        font-size: 1.125rem;
        font-weight: 500;
        margin: 0;
    }

    /* Custom navigation buttons */
    :global(.swiper-button-prev),
    :global(.swiper-button-next) {
        width: 3rem;
        height: 3rem;
        background: var(--bg-elevated);
        border-radius: 50%;
        box-shadow: var(--shadow-lg);
        opacity: 0.8;
        transition: all var(--transition-base);
    }

    :global(.swiper-button-prev:hover),
    :global(.swiper-button-next:hover) {
        opacity: 1;
        transform: scale(1.1);
    }

    :global(.swiper-button-prev::after),
    :global(.swiper-button-next::after) {
        font-size: 1.25rem;
        color: var(--text-primary);
        font-weight: 900;
    }

    /* Custom pagination dots */
    :global(.swiper-pagination-bullet) {
        width: 0.75rem;
        height: 0.75rem;
        background: white;
        opacity: 0.5;
        transition: all var(--transition-base);
    }

    :global(.swiper-pagination-bullet-active) {
        opacity: 1;
        background: var(--color-primary);
        transform: scale(1.3);
    }

    /* Reduced Motion */
    @media (prefers-reduced-motion: reduce) {
        .carousel-image,
        .ken-burns {
            transition: none !important;
            transform: none !important;
        }

        :global(.swiper-button-prev:hover),
        :global(.swiper-button-next:hover) {
            transform: none !important;
        }
    }
</style>

<script
    define:vars={{
        carouselId,
        effect,
        autoplay,
        autoplayDelay,
        loop,
        showNavigation,
        showPagination,
    }}
>
    // Import Swiper at runtime
    import("swiper").then((Swiper) => {
        import("swiper/modules").then((modules) => {
            import("swiper/css").then(() => {
                if (effect === "fade") {
                    import("swiper/css/effect-fade");
                } else if (effect === "cube") {
                    import("swiper/css/effect-cube");
                }
                if (showNavigation) {
                    import("swiper/css/navigation");
                }
                if (showPagination) {
                    import("swiper/css/pagination");
                }

                // Initialize Swiper
                const swiperModules = [];
                if (autoplay) swiperModules.push(modules.Autoplay);
                if (effect === "fade") swiperModules.push(modules.EffectFade);
                if (effect === "cube") swiperModules.push(modules.EffectCube);
                if (showNavigation) swiperModules.push(modules.Navigation);
                if (showPagination) swiperModules.push(modules.Pagination);

                new Swiper.default(`.${carouselId}`, {
                    modules: swiperModules,
                    effect: effect,
                    loop: loop,
                    speed: 1000,
                    autoplay: autoplay
                        ? {
                              delay: autoplayDelay,
                              disableOnInteraction: false,
                          }
                        : false,
                    navigation: showNavigation
                        ? {
                              nextEl: `.${carouselId} .swiper-button-next`,
                              prevEl: `.${carouselId} .swiper-button-prev`,
                          }
                        : false,
                    pagination: showPagination
                        ? {
                              el: `.${carouselId} .swiper-pagination`,
                              clickable: true,
                          }
                        : false,
                    keyboard: {
                        enabled: true,
                    },
                    a11y: {
                        enabled: true,
                    },
                });
            });
        });
    });
</script>
