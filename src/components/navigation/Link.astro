---
/**
 * Link Component
 *
 * Unified link component with multiple visual variants and automatic active state detection.
 * Supports navigation links, footer links, inline content links, and button-style links.
 *
 * @component
 */

export interface Props {
  /** URL to link to */
  href: string;
  /** Visual style variant */
  variant?: "nav" | "footer" | "inline" | "button";
  /** Force active state (overrides automatic detection) */
  active?: boolean;
  /** Is this an external link? (adds target="_blank" rel="noopener") */
  external?: boolean;
  /** Additional CSS classes */
  class?: string;
  /** Aria label for accessibility */
  ariaLabel?: string;
}

const {
  href,
  variant = "nav",
  active: activeProp,
  external = false,
  class: className = "",
  ariaLabel,
} = Astro.props;

// Determine active state based on current URL
const currentPath = Astro.url.pathname;
const isActive =
  activeProp !== undefined
    ? activeProp
    : currentPath === href || (href !== "/" && currentPath.startsWith(href));

// External link attributes
const externalAttrs = external
  ? { target: "_blank", rel: "noopener noreferrer" }
  : {};
---

<a
  href={href}
  class:list={[
    "link",
    `link--${variant}`,
    { "link--active": isActive },
    className,
  ]}
  aria-current={isActive ? "page" : undefined}
  aria-label={ariaLabel}
  {...externalAttrs}
  {...!activeProp ? {} : { "data-no-auto-active": "" }}
>
  <slot />

  {variant === "nav" && <span class="link__underline" aria-hidden="true" />}
</a>

<script>
  // Client-side active state handling for View Transitions (persistent headers)
  function updateActiveLinks() {
    const currentPath = window.location.pathname;
    const links = document.querySelectorAll(
      "a.link:not([data-no-auto-active])",
    );

    links.forEach((link) => {
      const href = link.getAttribute("href");
      if (!href) return;

      // Normalize paths to handle trailing slashes consistently if needed
      // For now, exact match or simple prefix
      const isActive =
        href === "/"
          ? currentPath === "/"
          : currentPath === href || currentPath.startsWith(href);

      if (isActive) {
        link.classList.add("link--active");
        link.setAttribute("aria-current", "page");
      } else {
        link.classList.remove("link--active");
        link.removeAttribute("aria-current");
      }
    });
  }

  // Run on initial load
  updateActiveLinks();

  // Run on view transitions navigation
  document.addEventListener("astro:page-load", updateActiveLinks);
</script>

<style>
  /* === BASE LINK STYLES === */
  .link {
    text-decoration: none;
    transition: all var(--transition-base);
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
  }

  .link:focus-visible {
    outline: 2px solid var(--color-primary);
    outline-offset: 4px;
    border-radius: 4px;
  }

  /* === NAV VARIANT === */
  /* Used in main navigation (desktop header) */
  .link--nav {
    color: var(--text-secondary);
    padding: 0.5rem 0;
    flex-direction: column;
    font-size: 0.875rem;
    font-weight: 500;
    position: relative;
  }

  .link--nav:hover {
    color: var(--color-accent);
  }

  .link--nav.link--active {
    color: var(--color-primary);
    font-weight: 600;
  }

  /* Nav Underline Indicator */
  .link__underline {
    display: block;
    height: 2px;
    width: 0;
    background: linear-gradient(
      90deg,
      var(--color-secondary),
      var(--color-accent),
      var(--color-primary)
    );
    transition: width var(--transition-base);
    border-radius: 1px;
  }

  .link--nav:hover .link__underline {
    width: 100%;
  }

  .link--nav.link--active .link__underline {
    width: 100%;
    background: linear-gradient(
      90deg,
      var(--color-secondary),
      var(--color-accent),
      var(--color-primary)
    );
  }

  /* === FOOTER VARIANT === */
  /* Used in footer navigation */
  .link--footer {
    color: var(--text-secondary);
    font-size: 0.875rem;
  }

  .link--footer:hover {
    color: var(--color-primary-light);
    transform: translateX(2px);
  }

  .link--footer.link--active {
    color: var(--color-primary);
    font-weight: 500;
  }

  /* === INLINE VARIANT === */
  /* Used within prose/content blocks */
  .link--inline {
    color: var(--color-primary);
    text-decoration: underline;
    text-underline-offset: 2px;
    text-decoration-thickness: 1px;
  }

  .link--inline:hover {
    color: var(--color-primary-dark);
    text-decoration-thickness: 2px;
  }

  /* === BUTTON VARIANT === */
  /* Link styled as a button (for CTAs) */
  .link--button {
    padding: 0.625rem 1.5rem;
    border-radius: 0.5rem;
    background: var(--color-primary);
    color: var(--text-inverse);
    font-weight: 600;
    font-size: 0.875rem;
    box-shadow: var(--shadow-md);
  }

  .link--button:hover {
    background: var(--color-primary-dark);
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
  }

  .link--button:active {
    transform: translateY(0);
  }

  /* === REDUCED MOTION === */
  @media (prefers-reduced-motion: reduce) {
    .link,
    .link__underline {
      transition: none !important;
    }

    .link:hover {
      transform: none !important;
    }
  }
</style>
